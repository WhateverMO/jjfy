本页详细说明了数据成熟度评估系统中使用的数据库连接架构和管理策略。该项目采用双数据库方案，既使用 Django 内置的 SQLite 存储应用数据，也通过外部数据库连接处理评估数据。

## 架构概述

系统采用分层数据库连接策略，将应用数据与评估数据处理分离：

![[Pasted image 20251104175719.png]]

## 主要连接组件

### Django 数据库配置

主应用使用 Django 内置的 SQLite 数据库，配置在 [settings.py](/data-maturity-assessment/back/mysite/settings.py#L76-L85) 中：

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```

此配置处理应用的内部数据存储，包括用户管理、评估结果和系统元数据。

### 外部 MariaDB 连接

[externDB.py](/data-maturity-assessment/back/api/externDB.py#L8-L16) 模块为外部数据处理提供直接的 MariaDB 连接：

```python
conn = mariadb.connect(
    user="zjj",
    host="127.0.0.1",
    port=3306,
    database="test",
)
```

> [!NOTE]
> MariaDB 连接使用简单直接的连接模式，适用于独立脚本和批处理操作。连接管理采用手动方式，需要显式关闭游标和连接。

### 高级 SQL Server 连接类

精密的 [dbConnection](/data-maturity-assessment/back/sqlER/connection/connection.py#L9-L25) 类为 SQL Server 连接实现了上下文管理器模式：

```python
class dbConnection:
    def __init__(self, driver=None, server=None, database=None, 
                 username=None, password=None, schema_name=None):
                
    def __enter__(self):
        # 连接建立和配置
        
    def __exit__(self, exc_type, exc_value, traceback):
        # 自动连接清理
```

## 连接管理功能

### 数据库元数据操作

`dbConnection` 类提供全面的元数据访问方法：

| 方法 | 用途 | 返回类型 |
| --- | --- | --- |
| [schemas()](/data-maturity-assessment/back/sqlER/connection/connection.py#L32-L36) | 检索数据库架构 | 架构记录列表 |
| [tables()](/data-maturity-assessment/back/sqlER/connection/connection.py#L38-L48) | 获取带过滤的表信息 | 过滤后的表列表 |
| [fields()](/data-maturity-assessment/back/sqlER/connection/connection.py#L50-L62) | 提取表列元数据 | 列描述 |
| [pk()](/data-maturity-assessment/back/sqlER/connection/connection.py#L64-L75) | 识别主键 | 主键信息 |
| [fk()](/data-maturity-assessment/back/sqlER/connection/connection.py#L77-L89) | 映射外键关系 | 外键详情 |

### 数据查询操作

连接类通过 [selct\_all()](/data-maturity-assessment/back/sqlER/connection/connection.py#L64-L77) 方法实现结构化数据检索：

```python
def selct_all(self, table_name: str, schema_name: Optional[str] = None):
    # 构建支持架构的完整表名
    # 返回带元数据的结构化结果集
```

### 错误处理和资源管理

两种连接实现都包含全面的错误处理：

-   **MariaDB**：使用 try-catch 块，失败时回滚 [externDB.py](/data-maturity-assessment/back/api/externDB.py#L23-L30)
-   **SQL Server**：上下文管理器确保自动资源清理 [connection.py](/data-maturity-assessment/back/sqlER/connection/connection.py#L89-L91)

## 连接模式对比

| 方面 | externDB.py | connection.py |
| --- | --- | --- |
| **数据库类型** | MariaDB | SQL Server (通过 pyodbc) |
| **连接模式** | 手动 | 上下文管理器 |
| **资源管理** | 显式关闭 | 自动清理 |
| **元数据支持** | 基本表操作 | 全面架构内省 |
| **使用场景** | 简单操作 | 复杂 ER 图生成 |

## 集成点

数据库连接系统与多个关键组件集成：

1.  **ER 图生成**：SQL Server 连接类通过提供全面元数据访问支持 [ER 图生成](深入探讨/Django后端集成/ER图生成)
2.  **外部数据处理**：MariaDB 连接促进数据导入/导出操作
3.  **应用数据存储**：Django 的 SQLite 处理内部应用状态

## 配置指南

### 开发环境设置

开发时，确保配置以下连接参数：

-   **MariaDB**：在 [externDB.py](/data-maturity-assessment/back/api/externDB.py#L9-L13) 中更新凭据
-   **SQL Server**：实例化 `dbConnection` 时配置连接参数
-   **Django**：SQLite 无需额外配置

### 生产环境考虑

> [!NOTE]
> 考虑为生产部署实现连接池，以提高性能和资源利用率，特别是对于外部数据库连接。

## 后续步骤

要了解这些数据库连接在更广泛系统中的使用方式：

-   探索 [ER 图生成](深入探讨/Django后端集成/ER图生成) ，了解 SQL Server 连接类如何支持数据库可视化
-   查看 [API 端点概述](深入探讨/Django后端集成/API端点概述) ，了解数据库连接如何服务 REST API
-   检查 [评估管道架构](深入探讨/Django后端集成/ER图生成) ，了解数据在连接层中的流动

数据库连接管理系统为内部应用数据管理和外部数据处理需求提供了坚实的基础，支持全面的数据成熟度评估功能。