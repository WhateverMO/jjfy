评分计算方法实现了一个分层评分系统，该系统通过多个评估层级处理问卷回答，以生成全面的数据成熟度评估。该系统在三个分层层级上采用加权聚合技术，将原始问卷数据转换为有意义的成熟度分数。

## 分层分数架构

评分系统采用三层分层结构，分数从最细粒度（第3层）到最高层级（第1层）逐步计算，最终生成模型最终分数。

![[Pasted image 20251104165857.png]]

## 第3层分数计算

评分系统的基础始于在最细粒度层级处理问卷回答。[question\_2.py](/data-maturity-assessment/back/eval/question_2.py#L3-L11)中的`calculate_final_scores`函数将原始问卷计数转换为标准化分数。

### 输入处理

-   **问卷计数**：表示每个问题的选项选择的二维列表
-   **部分索引**：定义哪些问题属于每个评估模块
-   **模块总计**：每个模块的标准化分数（默认：100）

### 评分逻辑

该函数区分单选题和多选题：

1.  **单选题**（长度=2）：分数 = 基础分数 ×（正面回答数/总表单数）
2.  **多选题**：分数 =（基础分数 ×（总回答数/选项数））/总表单数

> [!NOTE]
> 评分系统使用单选题的最大回答数作为归一化的分母，确保在不同问题类型和回答量下的评分一致性。

## 加权分数聚合

核心评分逻辑位于[model\_score\_cal\_main.py](/data-maturity-assessment/back/eval/model_score_cal_main.py#L125-L165)中，通过`calculate_model_score`函数实现渐进式加权聚合。

### 分层加权函数

#### 第3层加权

`multiply_weights_scores_l3`函数\[back/eval/model\_score\_cal\_main.py#L13-L48)处理第3层分数计算，具有特殊映射能力：

```python
def multiply_weights_scores_l3(weights, scores):
        # 带映射的逐元素乘法
    weighted_scores = [map(weight * score) for weight, score in zip(weight_list, score_list)]
    # 求和并四舍五入到4位小数
```

#### 第1层和第2层加权

`multiply_weights_scores`函数\[back/eval/model\_score\_cal\_main.py#L50-L85)使用标准加权求和计算处理第1层和第2层聚合。

### 渐进式聚合过程

评分遵循五步渐进式聚合：

1.  **第3层 → 第2层**：计算第3层指标的加权分数并聚合到第2层
2.  **结构分割**：使用`split_list_at_indices`根据第2层结构分割第3层分数
3.  **第2层 → 第1层**：应用第2层权重生成第1层分数
4.  **第1层 → 最终**：使用第1层权重计算最终模型分数
5.  **结果结构化**：将分数组织成分层字典格式

### 列表分割逻辑

`split_list_at_indices`函数\[back/eval/model\_score\_cal\_main.py#L87-L124)支持根据分层要求灵活重构分数数组：

```python
def split_list_at_indices(lst, *split_sizes):
    # 验证分割大小与列表长度
    # 根据指定大小创建子列表
    # 自动处理剩余元素
```

## 与评估流程的集成

评分计算方法通过[eval.py](/data-maturity-assessment/back/eval/eval.py#L33-L44)中的`eval_qa`函数与更广泛的评估流程无缝集成。

### 流程集成点

1.  **权重计算**：从BWM或熵方法接收分层权重
2.  **分数处理**：接收来自问卷处理的第3层分数
3.  **分层聚合**：通过所有层级应用渐进式加权
4.  **结果格式化**：生成包含分数、权重和元数据的结构化输出

### 结果结构生成

[generate\_dict\_main.py](/data-maturity-assessment/back/eval/generate_dict_main.py#L163-L220)中的`build_score_structure`函数创建包含以下内容的全面结果字典：

-   **分层分数**：第1层、第2层和第3层分数
-   **权重信息**：每个层级对应的权重
-   **元数据**：总分和成熟度等级指定
-   **验证**：所有层级的参数一致性检查

## 错误处理和验证

评分系统实现了强大的验证机制：

1.  **维度匹配**：验证权重和分数数组的兼容性
2.  **索引验证**：确保问卷索引在有效范围内
3.  **输入清理**：优雅处理空格式或格式错误的输入
4.  **精度控制**：在整个计算过程中保持一致的小数精度（4位）

> [!NOTE]
> 所有评分函数都包含全面的输入验证和描述性错误消息，使开发和测试阶段的调试和故障排除更加高效。

## 性能考虑

评分系统针对以下方面进行了优化：

-   **内存效率**：尽可能就地处理分数
-   **计算简单性**：使用基本算术运算
-   **可扩展性**：处理可变分层结构
-   **精度**：在所有计算中保持一致的四舍五入

这种模块化方法允许轻松扩展和修改评分算法，同时保持与现有评估工作流程的向后兼容性。